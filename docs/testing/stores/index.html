<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Testing Stores</title>
  <meta name="description" content="A library for managing data within JavaScript applications. Alt is a pure flux implementation that is small, terse, well tested, extremely flexible, and forward thinking.
">

  <link rel="canonical" href="http://alt.js.org/docs/testing/stores/">
  <link rel="alternate" type="application/rss+xml" title="Alt" href="http://alt.js.org/feed.xml" />

  <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">

  <link type="text/css" rel="stylesheet" href="/assets/bootstrap-navbar.css" />
  <link type="text/css" rel="stylesheet" href="/assets/lotus.min.css" />
  <link type="text/css" rel="stylesheet" href="/assets/prism.min.css" />
  <link type="text/css" rel="stylesheet" href="/assets/styles.css" />
</head>


  <body>

    <nav class="navbar navbar-default sp-horiz-lg">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a class="navbar-brand" href="/"><img src="/assets/alt.png" alt="Alt" width="40" /></a>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div id="alt-search-app"></div>
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/guide/">Getting Started</a>
        </li>
        <li class="dropdown">
          <a href='#' class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">API Documentation <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li>
              <a href="/docs/">Alt</a>
            </li>
            
            <li>
              <a href="/docs/createActions">Creating Actions</a>
            </li>
            
            <li>
              <a href="/docs/actions">Actions</a>
            </li>
            
            <li>
              <a href="/docs/createStore">Creating Stores</a>
            </li>
            
            <li>
              <a href="/docs/stores">Stores</a>
            </li>
            
            <li>
              <a href="/docs/async">Handling Async</a>
            </li>
            
            <li>
              <a href="/docs/lifecycleListeners">Lifecycle Listeners</a>
            </li>
            
            <li>
              <a href="/docs/bootstrap">Bootstrap</a>
            </li>
            
            <li>
              <a href="/docs/takeSnapshot">Take Snapshot</a>
            </li>
            
            <li>
              <a href="/docs/flush">Flush</a>
            </li>
            
            <li>
              <a href="/docs/recycle">Recycle</a>
            </li>
            
            <li>
              <a href="/docs/rollback">Rollback</a>
            </li>
            
            <li>
              <a href="/docs/altInstances">Alt Instances</a>
            </li>
            
            <li>
              <a href="/docs/components/altContainer">AltContainer</a>
            </li>
            
          </ul>
        </li>
        <li>
          <a href="/blog/">Blog</a>
        </li>
        <li>
          <a href="https://gitter.im/goatslacker/alt">Support</a>
        </li>
        <li>
          <a href="https://github.com/goatslacker/alt">GitHub</a>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>


    <div class="main sp-vert-md sp-horiz-lg">
      <div class="row">
        <div class="col c2">
          <ul class="sidenav">
  
  <li>
    <a href="/docs/createActions">Creating Actions</a>
  </li>
  
  <li>
    <a href="/docs/actions">Actions</a>
  </li>
  
  <li>
    <a href="/docs/createStore">Creating Stores</a>
  </li>
  
  <li>
    <a href="/docs/stores">Stores</a>
  </li>
  
  <li>
    <a href="/docs/async">Handling Async</a>
  </li>
  
  <li>
    <a href="/docs/lifecycleListeners">Lifecycle Listeners</a>
  </li>
  
  <li>
    <a href="/docs/bootstrap">Bootstrap</a>
  </li>
  
  <li>
    <a href="/docs/takeSnapshot">Take Snapshot</a>
  </li>
  
  <li>
    <a href="/docs/flush">Flush</a>
  </li>
  
  <li>
    <a href="/docs/recycle">Recycle</a>
  </li>
  
  <li>
    <a href="/docs/rollback">Rollback</a>
  </li>
  
  <li>
    <a href="/docs/altInstances">Alt Instances</a>
  </li>
  
  <li>
    <a href="/docs/components/altContainer">AltContainer</a>
  </li>
  
</ul>

        </div>
        <div class="col c10">
          <div class="sp-horiz-md">
            <h1 id="testing-stores">Testing Stores</h1>

<h2 id="conceptual-how-to">Conceptual how to</h2>

<p>Since Flux stores have no direct setters testing the action handlers of a store or any of the store’s internal business can be tricky. This short tutorial demonstrates how to use ES6 modules in order to export both the alt created store as well as the store’s unwrapped model for testing.</p>

<p>The primary functionality of Stores in the Flux pattern is to listen for Actions, update/manage data to be used by the view, and emit change events to let the views know that data has been changed and they need to update. Based on this, the main thing we want to do is dispatch an event that our store is listening to (via <code>alt.dispatcher.dispatch(payload)</code>) and then check if the data in the store is updated in the way we expect (via methods that return data like <code>store.getState()</code> or <code>store.myPublicMethod()</code>).</p>

<p>This form of “blackbox testing” should cover most of your store testing needs, but what if our store methods that respond to actions do other things besides update data, or what if we have some other private helper methods that we need to test?</p>

<p>One thing we can do is to test our class before it is wrapped by alt, the unwrapped class. We should trust the alt library to test its own internals, so we can just test the inaccessible methods in our plain class by exporting it separately from our alt wrapped store (via <code>alt.createStore</code>). To do this, we can export it as a separate file, or use a named export for our unwrapped class and the default export for our alt wrapped class (in the example below, we will use the latter for simplicity).</p>

<p>The best way to demonstrate testing stores is with an example.</p>

<h2 id="example">Example</h2>

<p>You can also download and run this <a href="https://github.com/jdlehman/alt-example-tests">example</a>.</p>

<h3 id="store">Store</h3>

<pre><code class="language-javascript">// stores/PetStore.js
import alt from 'MyAlt'; // instance of alt
import petActions from 'actions/PetActions';

// named export
export class UnwrappedPetStore {
  constructor() {
    this.bindActions(petActions); // buyPet, sellPet

    this.pets = {hamsters: 2, dogs: 0, cats: 3};
    this.storeName = "Pete's Pets";
    this.revenue = 0;
  }

  onBuyPet({cost, pet}) {
    this.pets[pet]++;
    this.revenue -= this.roundMoney(cost);
  }

  onSellPet({price, pet}) {
    this.pets[pet]--;
    this.revenue += this.roundMoney(price);
  }

  // this is inaccessible from our alt wrapped store
  roundMoney(money) {
    // rounds to cents
    return Math.round(money * 100) / 100;
  }

  static getInventory() {
    return this.getState().pets;
  }
}

// default export
export default alt.createStore(UnwrappedPetStore, 'PetStore');
</code></pre>

<h3 id="related-actions">Related Actions</h3>

<pre><code class="language-javascript">// actions/PetActions.js
import alt from 'MyAlt';

class PetActions {
  constructor() {
    this.generateActions('buyPet', 'sellPet');
  }
}

export default alt.createActions(PetActions);
</code></pre>

<h3 id="store-test">Store test</h3>

<pre><code class="language-javascript">// tests/stores/PetStore_test.js
import alt from 'MyAlt';
// wrappedPetStore is alt store, UnwrappedPetStore is UnwrappedPetStore class
import wrappedPetStore, {UnwrappedPetStore} from 'stores/PetStore';
import petActions from 'actions/PetActions';
 // you can use any assertion library you want
import {assert} from 'chai';

// These testing utils will auto stub the stuff that alt.createStore does
import AltTestingUtils from 'alt/utils/AltTestingUtils';

describe('PetStore', () =&gt; {
  it('listens for buy a pet action', () =&gt; {
    // get initial state of store
    var oldRevenue = wrappedPetStore.getState().revenue,
        oldDogs = wrappedPetStore.getInventory().dogs;

    // create action to be dispatched
    var data = {cost: 10.223, pet: 'dogs'},
        action = petActions.BUY_PET;

    // dispatch action (store is listening for action)
    // NOTE: FB's dispatcher expects keys "action" and "data"
    alt.dispatcher.dispatch({action, data});

    // assertions
    assert.equal(wrappedPetStore.getState().revenue, oldRevenue - 10.22);
    assert.equal(wrappedPetStore.getInventory().dogs, oldDogs + 1);
  });

  it('listens for sell a pet action', () =&gt; {
    // get initial state of store
    var oldRevenue = wrappedPetStore.getState().revenue,
        oldDogs = wrappedPetStore.getInventory().dogs;

    // create action to be dispatched
    var data = {price: 40.125, pet: 'dogs'},
        action = petActions.SELL_PET;

    // dispatch action (store is listening for action)
    // NOTE: FB's dispatcher expects keys "action" and "data"
    alt.dispatcher.dispatch({action, data});

    // assertions
    assert.equal(wrappedPetStore.getState().revenue, oldRevenue + 40.13);
    assert.equal(wrappedPetStore.getInventory().dogs, oldDogs - 1);
  });

  // though we can see that this method is working from our tests above,
  // lets use this inaccessible method to show how we can test
  // non static methods if we desire/need to
  it('rounds money to 2 decimal places', () =&gt; {
    var unwrappedStore = AltTestingUtils.makeStoreTestable(alt, UnwrappedPetStore);
    assert.equal(unwrappedStore.roundMoney(21.221234), 21.22);
    assert.equal(unwrappedStore.roundMoney(11.2561341), 11.26)
  });
});
</code></pre>

<p>If you’re using jest to test it is advised you unmock your alt instance as well as alt itself.</p>

<p>You can set this up in your <code>package.json</code> like so:</p>

<pre><code class="language-js">"jest": {
  "unmockedModulePathPatterns": [
    "node_modules/alt",
    "alt.js"
  ]
}
</code></pre>

<p>You can also test the dispatcher by overwriting <code>alt.dispatcher</code>. Here is an example:</p>

<pre><code class="language-js">beforeEach(function() {
  alt = require('../../alt');
  alt.dispatcher = { register: jest.genMockFunction() };
  UnreadThreadStore = require('../UnreadThreadStore');
  callback = alt.dispatcher.register.mock.calls[0][0];
});
</code></pre>

<p>You can see a working jest test <a href="https://github.com/goatslacker/alt/blob/master/examples/chat/js/stores/__tests__/UnreadThreadStore-test.js">here</a> which tests the <a href="https://github.com/goatslacker/alt/blob/master/examples/chat/js/stores/UnreadThreadStore.js">UnreadThreadStore</a> from the <a href="https://github.com/goatslacker/alt/tree/master/examples/chat">flux chat example</a> application.</p>

          </div>
        </div>
      </div>
    </div>

    <script type="application/javascript" src="http://alt.js.org/assets/search.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.js"></script>
<script type="text/javascript">
  // Alias for javascript so syntax highlighting works fine
  Prism.languages.js = Prism.languages.javascript;
</script>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js" ></script>
<script type="text/javascript" src="/assets/bootstrap-navbar.min.js"></script>
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'goatslacker/alt'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>


  </body>

</html>
